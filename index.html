<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>High Range Blasters — Auction Assist</title>
  <link rel="stylesheet" href="/assets/styles.css" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
 <script>
// Load Supabase UMD (global) BEFORE your app scripts
    window.ENV = {
    SUPABASE_URL: "https://zwusmrtwnptkowgosfly.supabase.co",
    SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp3dXNtcnR3bnB0a293Z29zZmx5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzMzQzMDQsImV4cCI6MjA3NTkxMDMwNH0.IKrr8x6xOCXicSd1GJiDpR3mzamhytMCon0cY_1KxD4"
  };
</script>
</head>

<body>
 <nav class="row" style="gap:12px;margin-bottom:12px;">
  <a href="#playersList">Players</a>
  <a href="#liveBid">Live Bid</a>
  <a href="#addClubCard">Manage Clubs</a>
</nav>
<style>
  /* put anywhere in your CSS */
  #liveBid { scroll-margin-top: 80px; } /* adjust 80px to your header height */
</style>


  <div id="app" class="page">
    <header class="topbar">
      <div class="brand">
        <img src="/assets/highrange.svg" alt="High Range Blasters" class="brand-logo" />
        <h1>High Range Blasters — Auction Assist</h1>
      </div>
      <div class="top-actions">
        <button id="btn-export" class="btn">Export Won (CSV)</button>
        <button id="btn-reset" class="btn btn-ghost">Reset Session</button>
        <button id="btn-logout" class="btn btn-ghost" style="display:none">Logout</button>
      </div>
    </header>

    <!-- LOGIN -->
    <section id="loginView" class="card modal" style="display:none">
      <h2>Login</h2>
      <p class="hint">Enter your credentials to start the auction.</p>
      <div class="form-grid">
        <label> Username
          <input id="loginUser" placeholder="HRB" />
        </label>
        <label> Password
          <input id="loginPass" type="password" placeholder="sandeep" />
        </label>
      </div>
      <div class="row" style="margin-top:10px;">
        <button id="btn-login" class="btn">Login</button>
        <div id="loginError" class="hint" style="color:#dc2626;margin-left:8px;"></div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="settingsView" class="card modal" style="display:none">
      <h2>Pre-Bid Settings</h2>
      <p class="hint">Configure roster size, budget and category base values. For multiple preselected players use:
        <b>Name1=1200; Name2=900</b></p>
      <div class="form-grid">
        <label> Number of Players (max)
          <input type="number" id="cfgPlayersCap" placeholder="15" />
        </label>
        <label> Overall Points
          <input type="number" id="cfgTotalPoints" placeholder="15000" />
        </label>

        <label> Category 1 base (Rank 1–16)
          <input type="number" id="cfgBaseC1" placeholder="1500" />
        </label>
        <label> Category 2 base (Rank 17–24)
          <input type="number" id="cfgBaseC2" placeholder="1200" />
        </label>
        <label> Category 3 base (Rank 25–32)
          <input type="number" id="cfgBaseC3" placeholder="900" />
        </label>
        <label> Category 4 base (Rank 33–40)
          <input type="number" id="cfgBaseC4" placeholder="700" />
        </label>
        <label> Category 5 base (Rank >40)
          <input type="number" id="cfgBaseC5" placeholder="500" />
        </label>

        <label> Guardrail min/base per remaining slot
          <input type="number" id="cfgGuardMin" placeholder="(defaults to Cat 5)" />
        </label>

        <label> Preselected Player(s)
          <input id="cfgPreName" placeholder="Name=1200; Name2=900 (or single name)" />
        </label>
        <label> Single Preselected Bid (if only one name)
          <input type="number" id="cfgPreBid" placeholder="e.g. 1200" />
        </label>
      </div>

      <div class="stats" style="margin-top:10px;">
        <div class="stat">
          <span>Available Score (after preselected deduction)</span>
          <b id="cfgAvailableScore">—</b>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="btn-save-settings" class="btn">Save & Start</button>
        <div id="settingsError" class="hint" style="color:#dc2626;margin-left:8px;"></div>
      </div>
    </section>

    <!-- APP -->
    <main id="appMain" class="grid" style="display:none">
      <!-- LEFT -->
      <section class="card">
        <h2>Auction Controls</h2>
        <div class="form-grid">
          <label> Total Points
            <input type="number" id="totalPoints" />
          </label>
          <label> Players Needed
            <input type="number" id="playersNeeded" />
          </label>
          <label> Guardrail Min / Remaining Slot
            <input type="number" id="minBasePerPlayer" />
          </label>
          <div class="row">
            <button id="btn-shuffle" class="btn">Shuffle Queue</button>
            <button id="btn-next" class="btn">Next Player</button>
            <button id="btn-undo" class="btn btn-ghost">Undo</button>
          </div>
        </div>

        <div class="stats">
          <div class="stat"><span>Remaining Points</span><b id="remainingPoints">0</b></div>
          <div class="stat"><span>Remaining Slots</span><b id="remainingSlots">0</b></div>
          <div class="guard" id="guardrail">Guardrail: <b>OK</b></div>
        </div>

        <h3>Import / Export</h3>
        <div class="import">
          <label> Google Sheet CSV URL
            <input id="csvUrl" placeholder="https://docs.google.com/.../pub?output=csv" />
          </label>
          <div class="row">
            <button id="btn-fetch" class="btn">Fetch CSV</button>
            <button id="btn-clear-url" class="btn btn-ghost">Clear</button>
          </div>

          <label> Paste CSV
            <textarea id="csvPaste" rows="6"
              placeholder="name,rank,dob,alumni,age,rating10,role,base(optional),batting_hand,is_wk"></textarea>
          </label>
          <div class="row">
            <button id="btn-import" class="btn">Import</button>
            <button id="btn-clear-paste" class="btn btn-ghost">Clear</button>
          </div>
        </div>
      </section>

      <!-- MIDDLE -->
      <section class="card">
        <h2>Live Bid</h2>

        <!-- Start-a-bid typeahead -->
        <div class="typeahead">
          <label> Start Bid: type 3–4 letters, pick exact player
            <input id="startName" placeholder="e.g. Rah, Ana, Var" autocomplete="off" />
          </label>
          <div id="startResults" class="ta-menu" style="display:none"></div>
          <div class="row" style="margin-top:8px;">
            <label style="flex:1">Seed/Base Value (from category or sheet)
              <input type="number" id="seedBase" />
            </label>
            <button id="btn-start-bid" class="btn" style="align-self:flex-end">Set Active</button>
          </div>
        </div>

        <div id="liveBid" style="margin-top:10px"></div>
<!-- Pass / Assign to other club UI -->

        <h2 style="margin-top:14px">Selected Squad</h2>
        <div id="selectedList"></div>
      </section>

      <!-- RIGHT -->
      <section class="card">
        <h2>Players <small id="playersCount"></small></h2>
        <div id="complianceBar"></div>
        <div class="list" id="playersList"></div>
      </section>
    </main>
<!-- ADD CLUB (Minimal) -->
<section class="card" id="addClubCard">
  <h2>Add Club</h2>
  <div class="form-grid">
    <label>Club name
      <input id="clubName" placeholder="Coastal Strikers" />
    </label>
    <label>Logo URL (optional)
      <input id="clubLogo" placeholder="./assets/logo.svg or https://…" />
    </label>
    <label>Starting Budget (points)
      <input id="clubBudget" type="number" placeholder="15000" />
    </label>
  </div>
  <div class="row" style="margin-top:10px;">
    <button id="btnCreateClub" class="btn">Create Club</button>
    <div id="clubCreateMsg" class="hint" style="margin-left:8px;"></div>
  </div>
</section>
<!-- Pass / Assign to other club UI -->
<div id="passPanel" class="card" style="margin-top:10px; display:none">
  <h3>Assign to Other Club</h3>
  <div class="form-grid">
    <label> Club
      <!-- select is filled dynamically; datalist also enables type-to-search -->
      <input list="clubNames" id="passClubInput" placeholder="Start typing club name…" />
      <datalist id="clubNames"></datalist>
    </label>
    <label> Winning Price
      <input type="number" id="passBidAmount" placeholder="e.g. 900" />
    </label>
  </div>
  <div class="row" style="margin-top:8px;">
    <button id="btn-assign-to-club" class="btn">Assign</button>
    <div class="hint" id="passPanelMsg" style="margin-left:8px;"></div>
  </div>
</div>

<!-- OTHER CLUBS LIVE SQUADS -->
<section class="card">
  <h2>Other Clubs — Live Squads</h2>
  <p class="hint">Updates as you mark players “won” by other clubs.</p>
  <div id="otherClubsPanel" class="grid"></div>
</section>

    <footer class="footer">
      <span>Session is saved locally. Optional cloud sync via Supabase.</span>
    </footer>
  </div>

 <script type="module">
  function $(id){ return document.getElementById(id); }
  function isHidden(el){ return !el || el.offsetParent === null; }

  function showMainAppIfNeeded(targetId){
    // If Live Bid is requested but appMain is hidden, reveal it and hide modals
    if (targetId === "liveBid") {
      const appMain = $("appMain");
      if (appMain && getComputedStyle(appMain).display === "none") {
        // hide login/settings if they’re up
        const login = $("loginView"); if (login) login.style.display = "none";
        const settings = $("settingsView"); if (settings) settings.style.display = "none";
        appMain.style.display = "grid"; // was none
      }
    }
  }

  function scrollToId(id, tries = 12) {
    const el = $(id);
    if (el && !isHidden(el)) {
      el.scrollIntoView({ behavior: "smooth", block: "start" });
      return true;
    }
    if (tries > 0) setTimeout(() => scrollToId(id, tries - 1), 100);
    return false;
  }

  function wireHashScrolling() {
    document.querySelectorAll('a[href*="#"]').forEach(a => {
      a.addEventListener("click", (e) => {
        const href = a.getAttribute("href") || "";
        const id = href.includes("#") ? href.split("#").pop() : "";
        if (!id) return;
        e.preventDefault();
        history.pushState(null, "", "#" + id);
        showMainAppIfNeeded(id);
        // try a couple times in case Live Bid renders after showing appMain
        setTimeout(() => scrollToId(id), 0);
        setTimeout(() => scrollToId(id), 150);
      });
    });

    window.addEventListener("hashchange", () => {
      const id = (location.hash || "").slice(1);
      if (!id) return;
      showMainAppIfNeeded(id);
      scrollToId(id);
    });

    const initial = (location.hash || "").slice(1);
    if (initial) {
      showMainAppIfNeeded(initial);
      setTimeout(() => scrollToId(initial), 0);
    }
  }

  // Make sure the target doesn't hide under the header
  const style = document.createElement("style");
  style.textContent = `#liveBid { scroll-margin-top: 80px; }`;
  document.head.appendChild(style);

  document.addEventListener("DOMContentLoaded", wireHashScrolling);
</script>
<script type="module">
  // Force-bind Fetch/Import/Clear regardless of other script errors
  function bindOnce(el, type, handler){
    if (!el) return;
    el.replaceWith(el.cloneNode(true)); // drop existing listeners
    el = document.getElementById(el.id);
    el.addEventListener(type, handler);
  }

  function setMsg(text){
    const msg = document.getElementById("importMsg");
    if (msg) msg.textContent = text;
  }

  async function doFetchCsv(){
    try {
      setMsg("");
      const urlEl = document.getElementById("csvUrl");
      const pasteEl = document.getElementById("csvPaste");
      const url = (urlEl?.value || "").trim();
      if (!url) { setMsg("Enter a Google Sheet CSV URL"); return; }
      const resp = await fetch(url, { cache: "no-store" });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const text = await resp.text();
      if (pasteEl) pasteEl.value = text;
      setMsg("Fetched CSV — click Import to load players.");
    } catch (e) {
      console.error("Fetch CSV failed:", e);
      setMsg("Fetch failed. Check the URL & sharing (Publish to web).");
    }
  }

  function doImportCsv(){
    try {
      setMsg("");
      const pasteEl = document.getElementById("csvPaste");
      const raw = (pasteEl?.value || "").trim();
      if (!raw) { setMsg("Paste CSV data first or use Fetch CSV."); return; }
      const rows = raw.split(/\r?\n/).filter(Boolean);
      const header = rows.shift()?.split(",")?.map(h => h.trim().toLowerCase()) || [];
      const idx = n => header.indexOf(n);
      const idI=idx("id"), nameI=idx("name"), baseI=idx("base"), catI=idx("category"), rankI=idx("rank"), roleI=idx("role");
      const toNum = (v,d=0)=>{ const n=Number(v); return Number.isFinite(n)?n:d; };

      const players = rows.map((r,i)=>{
        const cols = r.split(",");
        return {
          id: (idI>=0?cols[idI]:String(i+1)).trim(),
          name: (nameI>=0?cols[nameI]:`Player ${i+1}`).trim(),
          base: toNum(baseI>=0?cols[baseI]: "", 500),
          category: (catI>=0?cols[catI]:"").trim(),
          rank: toNum(rankI>=0?cols[rankI]: i+1),
          role: (roleI>=0?cols[roleI]:"").trim(),
          status: "new"
        };
      });

      // minimal state injection so the rest of the UI can render
      const SKEY = "hrb-auction-state";
      let st = {};
      try { st = JSON.parse(localStorage.getItem(SKEY) || "{}") || {}; } catch {}
      st.players = players;
      if (!st.playersNeeded) st.playersNeeded = 15;
      if (!st.totalPoints) st.totalPoints = 15000;
      if (!st.minBasePerPlayer) st.minBasePerPlayer = 500;
      localStorage.setItem(SKEY, JSON.stringify(st));

      // if render() exists, call it; else reload as a fallback
      if (typeof window.render === "function") {
        window.render();
      }
      setMsg(`Imported ${players.length} players.`);
      // scroll to Players list for visibility
      document.getElementById("playersList")?.scrollIntoView({ behavior: "smooth", block: "start" });
    } catch(e){
      console.error("Import failed:", e);
      setMsg("Import failed. Check CSV format.");
    }
  }

  function doClearUrl(){ const el=document.getElementById("csvUrl"); if (el) el.value=""; setMsg(""); }
  function doClearPaste(){ const el=document.getElementById("csvPaste"); if (el) el.value=""; setMsg(""); }

  document.addEventListener("DOMContentLoaded", () => {
    bindOnce(document.getElementById("btn-fetch"), "click", doFetchCsv);
    bindOnce(document.getElementById("btn-import"), "click", doImportCsv);
    bindOnce(document.getElementById("btn-clear-url"), "click", doClearUrl);
    bindOnce(document.getElementById("btn-clear-paste"), "click", doClearPaste);
  });
</script>

</body>
</html>
