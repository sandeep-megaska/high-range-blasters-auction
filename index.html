<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>HRB Auction Assist</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root { --bg:#f7fafc; --card:#fff; --muted:#6b7280; --line:#e5e7eb; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:#0f172a; }
    .wrap { max-width:1200px; margin:0 auto; padding:18px; }
    h2,h3 { margin:0 0 10px; }
    .hint { color:var(--muted); font-size:12px; }
    .btn { padding:8px 12px; border-radius:8px; border:1px solid var(--line); background:#111827; color:#fff; cursor:pointer; }
    .btn[disabled] { opacity:.5; cursor:not-allowed; }
    .btn-ghost { background:#fff; color:#111827; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:12px; }
    input, textarea, select { width:100%; padding:8px 10px; border:1px solid var(--line); border-radius:8px; background:#fff; }
    label { font-size:12px; color:#111827; display:block; margin:6px 0; }
    .row { display:flex; gap:8px; align-items:center; }
    .topbar { display:flex; gap:18px; align-items:center; background:var(--card); border:1px solid var(--line); padding:10px 12px; border-radius:12px; }
    .topbar .stat { font-size:14px; }
    .topbar .right { margin-left:auto; display:flex; gap:8px; flex-wrap:wrap; }
    .main-grid { display:grid; grid-template-columns: 1.1fr 1fr 1fr; gap:14px; margin-top:14px; }
    .players, .live, .squad { min-height:420px; }
    .players .list { max-height:520px; overflow:auto; }
    .typeahead { margin:8px 0 10px; position:relative; }
    #startResults { position:absolute; left:0; right:0; top:100%; z-index:5; background:#fff; border:1px solid var(--line); border-radius:8px; display:none; max-height:220px; overflow:auto; }
    #startResults .ta-item { padding:8px 10px; border-bottom:1px solid var(--line); cursor:pointer; }
    #startResults .ta-item:hover { background:#f3f4f6; }
    .clubs-grid { display:grid; grid-template-columns: repeat( auto-fit, minmax(260px, 1fr) ); gap:12px; }
    .divider { height:1px; background:var(--line); margin:10px 0; }
    #settingsView, #appMain { display:none; }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- LOGIN -->
    <section id="loginView" class="card" style="max-width:440px; margin:40px auto; padding:18px;">
      <div class="row" style="gap:10px; margin-bottom:8px;">
        <h2>HRB Auction Assist — Login</h2>
      </div>
      <div class="row" style="gap:12px;">
        <label style="flex:1;">Username
          <input id="loginUser" placeholder="HRB" />
        </label>
        <label style="flex:1;">Password
          <input id="loginPass" type="password" placeholder="sandeep" />
        </label>
      </div>
      <div class="row" style="margin-top:10px;">
        <button id="btn-login" class="btn">Login</button>
        <div id="loginError" class="hint" style="margin-left:8px;"></div>
      </div>
    </section>

    <!-- SETTINGS (pre-auction) -->
    <section id="settingsView" class="card" style="padding:16px;">
      <h2>Pre-Bid Settings</h2>
      <div class="divider"></div>

      <div class="row" style="gap:14px; flex-wrap:wrap;">
        <label style="flex:1; min-width:180px;">Players cap
          <input id="cfgPlayersCap" type="number" value="15" />
        </label>
        <label style="flex:1; min-width:220px;">Total points (per club)
          <input id="cfgTotalPoints" type="number" value="15000" />
        </label>
        <label style="flex:1; min-width:200px;">Guardrail min base per slot
          <input id="cfgGuardMin" type="number" value="200" />
        </label>
      </div>

      <h3 style="margin-top:14px;">HRB Pre-selected player(s)</h3>
      <div class="row" style="gap:10px; flex-wrap:wrap;">
        <label style="flex:2; min-width:240px;">Names and prices (e.g. <i>Name1=1200; Name2=900</i>)
          <input id="cfgPreName" placeholder="John WK=1200; Anil LHB=900" />
        </label>
        <label style="flex:1; min-width:160px;">Single bid (used only if above has one name without “=price”)
          <input id="cfgPreBid" type="number" placeholder="900" />
        </label>
        <div class="row" style="align-items:flex-end;">
          <div class="hint">Available after preselected (HRB): <b id="cfgAvailableScore">15000</b></div>
        </div>
      </div>

      <h3 style="margin-top:14px;">Import players (CSV)</h3>
      <div class="row" style="gap:10px; flex-wrap:wrap;">
        <label style="flex:2; min-width:260px;">CSV URL (published to web; output=csv)
          <input id="csvUrl" placeholder="https://docs.google.com/spreadsheets/.../pub?output=csv" />
        </label>
        <div class="row" style="gap:8px; align-items:flex-end;">
          <button id="btn-fetch" class="btn">Fetch</button>
          <button id="btn-clear-url" class="btn btn-ghost">Clear</button>
        </div>
      </div>
      <label style="margin-top:8px;">Or paste CSV here
        <textarea id="csvPaste" rows="6" placeholder="Use HRB_Auction_Master_Template.csv headers"></textarea>
      </label>
      <div class="row" style="margin-top:8px;">
        <button id="btn-import" class="btn">Import Players</button>
        <button id="btn-clear-paste" class="btn btn-ghost">Clear Paste</button>
        <button id="btn-download-template" class="btn btn-ghost">Download CSV Template</button>
        <div id="importMsg" class="hint" style="margin-left:8px;"></div>
      </div>

      <h3 style="margin-top:18px;">Per-club preselected players</h3>
      <div id="clubPreselectedPanel" class="card" style="padding:12px;"></div>

      <div class="divider"></div>
      <div class="row" style="margin-top:8px;">
        <button id="btn-save-settings" class="btn">Save & Go to Auction</button>
        <div id="settingsError" class="hint" style="margin-left:8px;"></div>
      </div>
    </section>

    <!-- APP (auction) -->
    <section id="appMain">
      <div class="topbar">
        <div class="stat">Remaining Points: <b id="remainingPoints">0</b></div>
<div class="stat">Remaining Slots: <b id="remainingSlots">0</b></div>
<div class="stat" id="guardrail">Guardrail (min per slot): <b>200</b></div>


<!-- NEW: Round + Timer strip -->
<div class="stat" style="margin-left:18px;">
Round: <b id="roundNo">1</b>
</div>
<div class="stat">Timer: <b id="timerDisplay">00:45</b></div>


<div class="right">
<!-- NEW: timer controls -->
<button id="btn-timer-start" class="btn btn-ghost">Start</button>
<button id="btn-timer-pause" class="btn btn-ghost">Pause</button>
<button id="btn-timer-reset" class="btn btn-ghost">Reset</button>
<button id="btn-next-round" class="btn btn-ghost">Next Round</button>


<!-- NEW: Undo -->
<button id="btn-undo" class="btn btn-ghost" title="Undo last win/assign">Undo</button>


<button id="btn-export" class="btn btn-ghost">Export Won (CSV)</button>
<button id="btn-export-state" class="btn btn-ghost">Export All Players (CSV)</button>
<button id="btn-logout" class="btn btn-ghost">Logout</button>
</div>
      </div>

      <div id="complianceBar" class="row" style="margin:10px 0 0;"></div>

      <div class="main-grid">
        <!-- LEFT: Players & search -->
        <div class="players card" style="padding:12px;">
          <h3>Players <span id="playersCount" class="hint">(0)</span></h3>
          <div class="typeahead">
            <label>Find player by name (as announced on TV)</label>
            <input id="startName" placeholder="Start typing a name…" autocomplete="off" />
            <div id="startResults"></div>
          </div>
          <div class="row" style="gap:8px;">
            <label style="flex:1;">Seed / Base Value
              <input id="seedBase" disabled placeholder="auto" />
            </label>
            <button id="btn-start-bid" class="btn" style="align-self:flex-end;">Set Active</button>
          </div>
          <div class="divider"></div>
          <div id="playersList" class="list"></div>
        </div>

        <!-- MIDDLE: Live Bid -->
        <div class="live card" style="padding:12px;">
          <h3>Live Bid</h3>
          <div id="liveBid" style="margin-top:8px;"></div>

          <!-- Predictive Insights -->
          <div id="insightsPanel" class="card" style="margin-top:12px; padding:12px;">
            <div class="row" style="justify-content:space-between; align-items:center;">
              <h3 style="margin:0;">Live Insights</h3>
              <div class="row" style="gap:8px;">
                <label style="min-width:160px;">What-if bid
                  <input id="whatIfBid" type="number" placeholder="Try a number…" />
                </label>
                <button id="btn-apply-whatif" class="btn btn-ghost" style="align-self:flex-end;">Apply What-if</button>
              </div>
            </div>
            <div id="insightsContent" style="margin-top:8px; font-size:13px;"></div>
          </div>

          <div id="passPanel" class="card" style="margin-top:12px; padding:12px; display:none;">
            <div class="row" style="justify-content:space-between;">
              <div><b>Assign to another club</b></div>
            </div>
            <div class="row" style="gap:10px; flex-wrap:wrap; margin-top:8px;">
              <label style="flex:2; min-width:220px;">Club
                <input id="passClubInput" list="clubNames" placeholder="Type or pick a club…" />
                <datalist id="clubNames"></datalist>
              </label>
              <label style="flex:1; min-width:140px;">Final Bid
                <input id="passBidAmount" type="number" min="200" placeholder="900" />
              </label>
              <button id="btn-assign-to-club" class="btn" style="align-self:flex-end;">Assign</button>
            </div>
            <div id="passPanelMsg" class="hint" style="margin-top:6px;"></div>
          </div>
        </div>

        <!-- RIGHT: HRB Squad -->
        <div class="squad card" style="padding:12px;">
          <h3>HRB Selected Squad</h3>
          <div id="selectedList" style="margin-top:6px;"></div>
        </div>
      </div>

      <div style="margin-top:14px;">
        <h3>Other Clubs</h3>
        <div id="otherClubsPanel" class="clubs-grid"></div>
      </div>
    </section>
  </div>
<script src="app.smart-insights.addon.js"></script>
  <!-- Single script include; keep the filename exactly as assets/app.js -->
  <script defer src="./assets/app.js"></script>
  <script>
/* ===== Points Economy Enforcer (inline) ===== */
(function(){if(!window||!document)return;const $=id=>document.getElementById(id);
const toNum=(v,d=0)=>{const n=Number(v);return Number.isFinite(n)?n:d};
const getState=()=>window.state||{};const minBase=()=>200;
const getActivePlayer=()=>{const s=getState();const id=s.activePlayerId;
if(id==null)return null;return(s.players||[]).find(p=>String(p.id)===String(id))||null};
function minBidFor(p){return Math.max(minBase(),toNum(p&&p.base_point,minBase()))}
function remainingSlots(){const s=getState();const cap=toNum(s.playersNeeded,15);
const mine=(s.players||[]).filter(p=>p.owner===s.myClubSlug&&p.status==="won").length;
return Math.max(0,cap-mine)}
function remainingBudget(slug){const s=getState();
const c=(s.clubs||[]).find(c=>c.slug===slug);return c?toNum(c.budget_left,c.starting_budget||0):0}
function remainingFloor(excludeId=null,slotsOverride=null){const s=getState();
const pool=(s.players||[]).filter(p=>p.status!=="won"&&(excludeId?String(p.id)!==String(excludeId):true));
const k=Math.max(0,(slotsOverride==null?remainingSlots():slotsOverride));if(k<=0)return 0;
const bases=pool.map(p=>minBidFor(p)).sort((a,b)=>a-b);let sum=0;
for(let i=0;i<Math.min(k,bases.length);i++)sum+=bases[i];
if(bases.length<k)sum+=(k-bases.length)*minBase();return sum}
function validateBidAgainstBase(p,bidValue){const bid=Number(bidValue||0);if(!p)return false;return bid>=minBidFor(p)}
window.guardrailOK=function(bid){const s=getState();const p=getActivePlayer();const price=Number(bid||0);
if(!p||!Number.isFinite(price))return false;if(!validateBidAgainstBase(p,price))return false;
const bud=remainingBudget(s.myClubSlug);const remSlotsAfter=Math.max(0,remainingSlots()-1);
const floorAfter=remainingFloor(p.id,remSlotsAfter);return(price<=bud)&&((bud-price)>=floorAfter)}
window.maxYouCanSpendNow=function(playerOpt){const s=getState();const p=playerOpt||getActivePlayer();
const bud=remainingBudget(s.myClubSlug);const remSlotsAfter=Math.max(0,remainingSlots()-1);
const floorAfter=remainingFloor(p&&p.id,remSlotsAfter);return Math.max(minBidFor(p||{}),bud-floorAfter)}
const _markWon=window.markWon;window.markWon=function(playerId,price){const s=getState();
const p=(s.players||[]).find(x=>x.id===playerId)||getActivePlayer();const bid=Number(price||0);
if(!p){console.warn("[enforcer] no player");return}
if(!validateBidAgainstBase(p,bid)){alert(`⚠️ Bid cannot be less than base point (${p.base_point}).`);return}
if(!window.guardrailOK(bid)){alert("⚠️ Guardrail: this bid would leave insufficient points to fill remaining slots at base.");return}
if(typeof _markWon==="function"){return _markWon(playerId,bid)}p.status="won";p.finalBid=bid;p.owner=s.myClubSlug;
if(typeof window.recomputeBudgetsFromWins==="function")window.recomputeBudgetsFromWins();
if(typeof window.persist==="function")window.persist();if(typeof window.render==="function")window.render()}
const _assign=window.assignToClubByNameOrSlug;window.assignToClubByNameOrSlug=function(playerId,clubText,price){
const s=getState();const p=(s.players||[]).find(x=>x.id===playerId)||getActivePlayer();const bid=Number(price||0);
if(!p){console.warn("[enforcer] no player");return}
if(!validateBidAgainstBase(p,bid)){alert(`⚠️ Bid cannot be less than base point (${p.base_point}).`);return}
if(typeof _assign==="function"){return _assign(playerId,clubText,bid)}
const club=(s.clubs||[]).find(c=>c.slug===String(clubText).toLowerCase().replace(/\s+/g,"-")||c.name===clubText);
if(!club){alert("Club not found");return}p.status="won";p.finalBid=bid;p.owner=club.slug;
if(typeof window.recomputeBudgetsFromWins==="function")window.recomputeBudgetsFromWins();
if(typeof window.persist==="function")window.persist();if(typeof window.render==="function")window.render()}
function attachButton(){const btn=document.getElementById("btn-mark-won");
const bidInput=document.getElementById("bidInput");const warnEl=document.getElementById("bidWarn");
const p=getActivePlayer();if(!btn||!bidInput)return;if(p)bidInput.min=String(minBidFor(p));
function check(){const val=Number(bidInput.value||0);const player=getActivePlayer();if(!player)return;
if(warnEl){if(!validateBidAgainstBase(player,val)){warnEl.textContent="Enter a bid ≥ base point: "+minBidFor(player)}
else if(!window.guardrailOK(val)){warnEl.textContent="Guardrail: this bid would leave insufficient points to complete the squad."}
else{warnEl.textContent=""}}}
bidInput.addEventListener("input",check);btn.addEventListener("click",function(ev){ev.preventDefault();
const player=getActivePlayer();if(!player)return;const val=Number(bidInput.value||0);
if(!validateBidAgainstBase(player,val)){alert(`⚠️ Bid cannot be less than base point (${player.base_point}).`);return}
if(!window.guardrailOK(val)){const maxNow=window.maxYouCanSpendNow(player);
alert(`⚠️ Guardrail: reduce bid.\nYou can safely spend up to ${maxNow} now.`);return}
window.markWon(player.id,val)},{passive:false})}
if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",attachButton)}else{attachButton()}
/* ===== UI sync helpers ===== */
(function(){const $=id=>document.getElementById(id);const toNum=(v,d=0)=>{const n=Number(v);return Number.isFinite(n)?n:d};
const getState=()=>window.state||{};const minBase=()=>200;function getActivePlayer(){const s=getState();
const id=s.activePlayerId;if(id==null)return null;return(s.players||[]).find(p=>String(p.id)===String(id))||null}
function minBidFor(p){return Math.max(minBase(),toNum(p&&p.base_point,minBase()))}
const bidInput=$("bidInput");const btnWon=$("btn-mark-won");const warnEl=$("bidWarn");if(!bidInput||!btnWon)return;
function runValidation(){const p=getActivePlayer();if(!p){btnWon.disabled=true;return}
const val=Number(bidInput.value||0);let ok=true;if(val<minBidFor(p))ok=false;
if(ok&&typeof window.guardrailOK==="function"){ok=!!window.guardrailOK(val)}
btnWon.disabled=!ok;if(warnEl){if(val<minBidFor(p)){warnEl.textContent="Enter a bid ≥ base point: "+minBidFor(p)}
else if(!ok){const maxNow=(typeof window.maxYouCanSpendNow==="function")?window.maxYouCanSpendNow(p):val;
warnEl.textContent="Guardrail: reduce bid. You can safely spend up to "+maxNow+" now."}else{warnEl.textContent=""}}}
function refreshForActive(){const p=getActivePlayer();if(!p){btnWon.disabled=true;if(warnEl)warnEl.textContent="Select a player to bid.";return}
bidInput.min=String(minBidFor(p));const v=Number(bidInput.value||0);if(!Number.isFinite(v)||v<minBidFor(p)){bidInput.value=String(minBidFor(p))}
runValidation()}
bidInput.addEventListener("input",runValidation);const obs=new MutationObserver(()=>{refreshForActive()});
obs.observe(document.body,{childList:true,subtree:true});window.addEventListener("hrb:active-player-changed",refreshForActive);
window.addEventListener("hrb:render",refreshForActive);
if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",refreshForActive)}else{refreshForActive()}})();
})();
</script>

</body>
</html>
